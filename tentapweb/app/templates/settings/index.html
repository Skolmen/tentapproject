{% extends "components/base.html" %}
{% block page_title %}Inst√§llningar{% endblock %}
{% block head %}
    {{ super() }}
    <!--<script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>-->
    <script>
        const VAPID_PUBLIC_KEY = "{{config['VAPID_PUBLIC_KEY']}}"
    </script>
    <!--<script type="module" src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>-->
    <!--<script type="module" src="https://www.gstatic.com/firebasejs/10.5.2/firebase-messaging.js"></script>-->
    <!--<script type="module" src="{{ url_for('static', filename='settings/scripts.js') }}"></script>-->
    <!--<script type="module" src="{{ url_for('static', filename='settings/init-firebase.js') }}"></script>-->
    <style>
        button {
            width: 80px;
            height: 40px;
            font-size: 18px;
        }

        input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        label {
            font-size: 18px;
        }

        select {
            width: 130px;
            height: 40px;
            font-size: 18px;
        }
        
    </style>
{% endblock %}
{% block heading %}
‚öô Inst√§llningar
{% endblock %}
{% block content %}
    <div class="mid">
        <div class="sub-setting">
            <h2>üîî Notiser</h2>
            <form id="notification-form">
                <label for="notifications-on">P√•</label>
                <input type="radio" name="notification-status" id="notifications-on" value="on">
                <label for="notifications-off">Av</label>

                <input type="radio" name="notification-status" id="notifications-off" value="off">

                <br>

                <label for="person">Person</label>
                <select name="person" id="person">
                    <option value="" selected disabled>V√§lj person</option>
                    {% for person in persons %}
                        <option value="{{ person.person_id }}">{{ person.name }}</option>
                    {% endfor %}
                </select>

                <br>
                <br>

                <button type="submit">Spara</button>
            </form>
                <form id="notificaiton-settings">
                <h3>üïê P√•minnelse av bokning</h3>
                <input type="radio" name="reminder" id="reminder-on" value="on">
                <label for="reminder-on">P√•</label>
                <input type="radio" name="reminder" id="reminder-off" value="off">
                <label for="reminder-off">Av</label>
                <br>
                <h3>üè† P√•minnelse av dagens salar</h3>
                <input type="radio" name="room-reminder" id="room-reminder-on" value="on">	
                <label for="room-reminder-on">P√•</label>
                <input type="radio" name="room-reminder" id="room-reminder-off" value="off">
                <label for="room-reminder-off">Av</label>
                <br>
                <h3>üè† P√•minnelse av morgondagens salar</h3>
                <input type="radio" name="room-reminder-tomorrow" id="room-reminder-tomorrow-on" value="on">
                <label for="room-reminder-tomorrow-on">P√•</label>
                <input type="radio" name="room-reminder-tomorrow" id="room-reminder-tomorrow-off" value="off">
                <label for="room-reminder-tomorrow-off">Av</label>
                <br>
                <br>
                <button type="submit">Spara</button>
            </form>
            
        </div>
    </div>
{% endblock %}
{% block endOfBody %}
<script type="module">
    import { subscribeToNotifications, unSubscribeToNotifications, detectNewToken, updateSettingsForToken, setLocalStorageSettings } from "{{ url_for('static', filename='settings/init-fcm.js') }}"
    import { queueModal } from "{{ url_for('static', filename='global/modal.js') }}"

    //Check notification status from local storage update it so if
    function checkNotificationStatus() {
        const notificationStatus = localStorage.getItem('notificationStatus');
        if (notificationStatus === 'true') {
            document.getElementById('notifications-on').checked = true;
        } else {
            document.getElementById('notifications-off').checked = true;
            localStorage.setItem('notificationStatus', 'false');
        }
    }

    checkNotificationStatus();

    //Using the form subscribe to notifications if notifications-on is true and unsubscribe if notifications-off is true using requestPermission and deleteToken if and sending the person id to the backend
    const form = document.getElementById('notification-form');
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const notificationStatus = formData.get('notification-status');
        const person = formData.get('person');
        if (notificationStatus === 'on' && person !== null && localStorage.getItem('notificationStatus') === 'false') {
            subscribeToNotifications(person);
        } else if (notificationStatus === 'off' && localStorage.getItem('notificationStatus') === 'true') {
            unSubscribeToNotifications();
        } else if (notificationStatus === 'on' && person !== null && localStorage.getItem('notificationStatus') === 'true') {
            queueModal('‚Ñπ Du √§r redan prenumererad p√• notiser', "info");
        } else if (notificationStatus === 'off' && localStorage.getItem('notificationStatus') === 'false') {
            queueModal('‚Ñπ Du √§r redan avprenumererad p√• notiser', "info");
        } else if (notificationStatus === 'on' && person === null) {
            queueModal('Du m√•ste v√§lja en person', "error");
        } 
    });

    if (localStorage.getItem('person_id')) {
        document.getElementById('person').value = localStorage.getItem('person_id');
    }

    detectNewToken();

    function checkNotificationSettings() {
        const reminder = localStorage.getItem('reminder');
        const roomReminder = localStorage.getItem('roomReminder');
        const roomReminderTomorrow = localStorage.getItem('roomReminderTomorrow');
        if (reminder === 'true') {
            document.getElementById('reminder-on').checked = true;
        } else {
            document.getElementById('reminder-off').checked = true;
            localStorage.setItem('reminder', 'false');
        }
        if (roomReminder === 'true') {
            document.getElementById('room-reminder-on').checked = true;
        } else {
            document.getElementById('room-reminder-off').checked = true;
            localStorage.setItem('roomReminder', 'false');
        }
        if (roomReminderTomorrow === 'true') {
            document.getElementById('room-reminder-tomorrow-on').checked = true;
        } else {
            document.getElementById('room-reminder-tomorrow-off').checked = true;
            localStorage.setItem('roomReminderTomorrow', 'false');
        }
    
    }

    checkNotificationSettings();

    const notificationForm = document.getElementById('notificaiton-settings');
    notificationForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(notificationForm);
        const reminder = formData.get('reminder');
        const roomReminder = formData.get('room-reminder');
        const roomReminderTomorrow = formData.get('room-reminder-tomorrow');
        updateSettingsForToken().then(() => {
            queueModal('‚úÖ Inst√§llningar sparade', "success");
            if (reminder === 'on') {
                localStorage.setItem('reminder', 'true');
            } else {
                localStorage.setItem('reminder', 'false');
            }
            if (roomReminder === 'on') {
                localStorage.setItem('roomReminder', 'true');
            } else {
                localStorage.setItem('roomReminder', 'false');
            }
            if (roomReminderTomorrow === 'on') {
                localStorage.setItem('roomReminderTomorrow', 'true');
            } else {
                localStorage.setItem('roomReminderTomorrow', 'false');
            }
        }).catch((error) => {
            if (error === 'not-subscribed') {
                setLocalStorageSettings(false);
                queueModal('‚ùå Du √§r inte prenumererad p√• notiser', "error");
            } else {
                queueModal('‚ùå N√•got gick fel', "error");
            }
        })
    });

</script>
{% endblock %}


<!--

<!DOCTYPE html>
<html>
<head>
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='settings/stylesheet.css') }}">
    <script>
        const VAPID_PUBLIC_KEY = "{{config['VAPID_PUBLIC_KEY']}}"
    </script>
    <script src="{{ url_for('static', filename='worker.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='settings/scripts.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='settings/init-firebase.js') }}"></script>
    <title>Bokningar</title>
</head>
<body>
    <div class="top">
        <h1>‚öô Inst√§llningar</h1>
    </div>
    <div class="mid">
        <div class="sub-setting">
            <h2>üîî Notiser</h2>
            <form id="notification-form">
                <label for="notifications-on">P√•</label>
                <input type="radio" name="notification-status" id="notifications-on" value="on">
                <label for="notifications-off">Av</label>
                <input type="radio" name="notification-status" id="notifications-off" value="off">

                <br>

                <label for="person">Person</label>
                <select name="person" id="person">
                    <option value="1">Test</option>
                    <option value="1">Te</option>
                    <option value="1">Tst</option>
                    <option value="1">Tet</option>
                </select>

                <br>

                <button type="submit">Spara</button>
            </form>
        </div>
    </div>

    <div id="t">f</div>

    <button id="sub">Subscribe</button>


    <script type="module">
        import { requestPermission, messaging } from "{{ url_for('static', filename='settings/scripts.js') }}"
        import { onMessage } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-messaging.js"


        const button = document.getElementById('sub');
        button.addEventListener('click', () => {
          requestPermission(); // Call the imported function
        });

        onMessage(messaging, (payload) => {
        console.log('Message received. ', payload);
        // ...
        });

    </script>
</body>
</html>
-->